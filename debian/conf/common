#!/bin/sh

#### Bootstrap

# This snippet is
if [ -n "$-" -a -z "${-##*a*}" ]; then
    # sourced by simple-cdd build environment

    # This is default path for build-simple-cdd(1) set by internal VARIABLES
    # in python3/dist-packages/simple_cdd/variables.py.
    simple_cdd_dir="${simple_cdd_dir:-$PWD}"

    # Usage: include_deps <dir> <group> <profile> [<profile_desc>] ...
    include_deps()
    {
        # Order is important to set @profiles and @auto_profiles correctly
        include_skip_profile_all "${path:+$rootdir/$1/}./$3.conf"

        # Make sure we agreed on profile name
        if [ "$3" != "$profile" ]; then
            echo >&2 "$2: build script ($3) and config ($profile) profile name mismatch"
            exit 1
        fi

        # Make directory early
        mkdir -p "$simple_cdd_dir"

        # Flush defs file contents from previous run if any
        :>"$simple_cdd_dir/defs"

        # Instance specific temporary directory
        export simple_cdd_temp="${simple_cdd_dir}/tmp/$3"
    }

    if [ -z "${1:+x}" ]; then
        echo >&2 'usage: . ./profiles/sh/common <dir> <group> <profile> [<profile_desc>]'
        exit 1
    fi

    # Execute bootstrap code from distro specific config file
    . "$simple_cdd_dir/profiles/sh/bootstrap" "$@"
else
    # sourced by profile build script

    # Make sure to update adjacent code in profile_env() from
    # distro specific config (e.g. distro.conf) when modifying
    # list of included variables here.
    exec env -i \
        ${PATH+PATH="$PATH"} \
        ${TERM+TERM="$TERM"} \
        ${LOGNAME+LOGNAME="$LOGNAME"} \
        ${USER+USER="$USER"} \
        ${USERNAME+USERNAME="$USERNAME"} \
        ${HOSTNAME+HOSTNAME="$HOSTNAME"} \
        ${HOME+HOME="$HOME"} \
        ${SHELL+SHELL="$SHELL"} \
        ${PWD+PWD="$PWD"} \
        ${MAIL+MAIL="$MAIL"} \
        ${LANG+LANG="$LANG"} \
        ${LANGUAGE+LANGUAGE="$LANGUAGE"} \
        ${LC_ALL+LC_ALL="$LC_ALL"} \
        ${LC_CTYPE+LC_CTYPE="$LC_CTYPE"} \
        build-simple-cdd "$@" --conf "./profiles/$this" ||
    exit
fi

#### Profile configuration
